{"version":3,"file":"files_versions-files_versions.mjs","sources":["../apps/files_versions/src/utils/davClient.js","../apps/files_versions/src/utils/davRequest.js","../apps/files_versions/src/utils/logger.js","../apps/files_versions/src/utils/versions.ts","../apps/files_versions/src/components/Version.vue","../apps/files_versions/src/components/VirtualScrolling.vue","../apps/files_versions/src/components/VersionLabelForm.vue","../apps/files_versions/src/views/VersionTab.vue","../apps/files_versions/src/files_versions_tab.js"],"sourcesContent":["/**\n * @copyright 2022 Louis Chemineau <mlouis@chmn.me>\n *\n * @author Louis Chemineau <mlouis@chmn.me>\n *\n * @license AGPL-3.0-or-later\n *\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport { createClient } from 'webdav'\nimport { generateRemoteUrl } from '@nextcloud/router'\nimport { getRequestToken } from '@nextcloud/auth'\n\nconst rootPath = 'dav'\n\n// init webdav client on default dav endpoint\nconst remote = generateRemoteUrl(rootPath)\nexport default createClient(remote, {\n\theaders: {\n\t\t// Add this so the server knows it is an request from the browser\n\t\t'X-Requested-With': 'XMLHttpRequest',\n\t\t// Inject user auth\n\t\trequesttoken: getRequestToken() ?? '',\n\t},\n})\n","/**\n * @copyright Copyright (c) 2019 Louis Chmn <louis@chmn.me>\n *\n * @author Louis Chmn <louis@chmn.me>\n *\n * @license AGPL-3.0-or-later\n *\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n *\n */\n\nexport default `<?xml version=\"1.0\"?>\n<d:propfind xmlns:d=\"DAV:\"\n\txmlns:oc=\"http://owncloud.org/ns\"\n\txmlns:nc=\"http://nextcloud.org/ns\"\n\txmlns:ocs=\"http://open-collaboration-services.org/ns\">\n\t<d:prop>\n\t\t<d:getcontentlength />\n\t\t<d:getcontenttype />\n\t\t<d:getlastmodified />\n\t\t<d:getetag />\n\t\t<nc:version-label />\n\t\t<nc:has-preview />\n\t</d:prop>\n</d:propfind>`\n","/**\n * @copyright 2022 Louis Chemineau <mlouis@chmn.me>\n *\n * @author Louis Chemineau <mlouis@chmn.me>\n *\n * @license AGPL-3.0-or-later\n *\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport { getLoggerBuilder } from '@nextcloud/logger'\n\nexport default getLoggerBuilder()\n\t.setApp('files_version')\n\t.detectUser()\n\t.build()\n","/* eslint-disable @typescript-eslint/no-explicit-any */\n/* eslint-disable jsdoc/require-param */\n/* eslint-disable jsdoc/require-jsdoc */\n/**\n * @copyright 2022 Louis Chemineau <mlouis@chmn.me>\n *\n * @author Louis Chemineau <mlouis@chmn.me>\n *\n * @license AGPL-3.0-or-later\n *\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport { getCurrentUser } from '@nextcloud/auth'\nimport { joinPaths } from '@nextcloud/paths'\nimport { generateRemoteUrl, generateUrl } from '@nextcloud/router'\nimport moment from '@nextcloud/moment'\n\nimport { encodeFilePath } from '../../../files/src/utils/fileUtils.ts'\n\nimport client from '../utils/davClient.js'\nimport davRequest from '../utils/davRequest.js'\nimport logger from '../utils/logger.js'\nimport type { FileStat, ResponseDataDetailed } from 'webdav'\n\nexport interface Version {\n\tfileId: string, // The id of the file associated to the version.\n\tlabel: string, // 'Current version' or ''\n\tfilename: string, // File name relative to the version DAV endpoint\n\tbasename: string, // A base name generated from the mtime\n\tmime: string, // Empty for the current version, else the actual mime type of the version\n\tetag: string, // Empty for the current version, else the actual mime type of the version\n\tsize: string, // Human readable size\n\ttype: string, // 'file'\n\tmtime: number, // Version creation date as a timestamp\n\tpermissions: string, // Only readable: 'R'\n\thasPreview: boolean, // Whether the version has a preview\n\tpreviewUrl: string, // Preview URL of the version\n\turl: string, // Download URL of the version\n\tsource: string, // The WebDAV endpoint of the ressource\n\tfileVersion: string|null, // The version id, null for the current version\n}\n\nexport async function fetchVersions(fileInfo: any): Promise<Version[]> {\n\tconst path = `/versions/${getCurrentUser()?.uid}/versions/${fileInfo.id}`\n\n\ttry {\n\t\tconst response = await client.getDirectoryContents(path, {\n\t\t\tdata: davRequest,\n\t\t\tdetails: true,\n\t\t}) as ResponseDataDetailed<FileStat[]>\n\n\t\treturn response.data\n\t\t\t// Filter out root\n\t\t\t.filter(({ mime }) => mime !== '')\n\t\t\t.map(version => formatVersion(version, fileInfo))\n\t} catch (exception) {\n\t\tlogger.error('Could not fetch version', { exception })\n\t\tthrow exception\n\t}\n}\n\n/**\n * Restore the given version\n */\nexport async function restoreVersion(version: Version) {\n\ttry {\n\t\tlogger.debug('Restoring version', { url: version.url })\n\t\tawait client.moveFile(\n\t\t\t`/versions/${getCurrentUser()?.uid}/versions/${version.fileId}/${version.fileVersion}`,\n\t\t\t`/versions/${getCurrentUser()?.uid}/restore/target`,\n\t\t)\n\t} catch (exception) {\n\t\tlogger.error('Could not restore version', { exception })\n\t\tthrow exception\n\t}\n}\n\n/**\n * Format version\n */\nfunction formatVersion(version: any, fileInfo: any): Version {\n\tconst mtime = moment(version.lastmod).unix() * 1000\n\tlet previewUrl = ''\n\n\tif (mtime === fileInfo.mtime) { // Version is the current one\n\t\tpreviewUrl = generateUrl('/core/preview?fileId={fileId}&c={fileEtag}&x=250&y=250&forceIcon=0&a=0', {\n\t\t\tfileId: fileInfo.id,\n\t\t\tfileEtag: fileInfo.etag,\n\t\t})\n\t} else {\n\t\tpreviewUrl = generateUrl('/apps/files_versions/preview?file={file}&version={fileVersion}', {\n\t\t\tfile: joinPaths(fileInfo.path, fileInfo.name),\n\t\t\tfileVersion: version.basename,\n\t\t})\n\t}\n\n\treturn {\n\t\tfileId: fileInfo.id,\n\t\tlabel: version.props['version-label'],\n\t\tfilename: version.filename,\n\t\tbasename: moment(mtime).format('LLL'),\n\t\tmime: version.mime,\n\t\tetag: `${version.props.getetag}`,\n\t\tsize: version.size,\n\t\ttype: version.type,\n\t\tmtime,\n\t\tpermissions: 'R',\n\t\thasPreview: version.props['has-preview'] === 1,\n\t\tpreviewUrl,\n\t\turl: joinPaths('/remote.php/dav', version.filename),\n\t\tsource: generateRemoteUrl('dav') + encodeFilePath(version.filename),\n\t\tfileVersion: version.basename,\n\t}\n}\n\nexport async function setVersionLabel(version: Version, newLabel: string) {\n\treturn await client.customRequest(\n\t\tversion.filename,\n\t\t{\n\t\t\tmethod: 'PROPPATCH',\n\t\t\tdata: `<?xml version=\"1.0\"?>\n\t\t\t\t\t<d:propertyupdate xmlns:d=\"DAV:\"\n\t\t\t\t\t\txmlns:oc=\"http://owncloud.org/ns\"\n\t\t\t\t\t\txmlns:nc=\"http://nextcloud.org/ns\"\n\t\t\t\t\t\txmlns:ocs=\"http://open-collaboration-services.org/ns\">\n\t\t\t\t\t<d:set>\n\t\t\t\t\t\t<d:prop>\n\t\t\t\t\t\t\t<nc:version-label>${newLabel}</nc:version-label>\n\t\t\t\t\t\t</d:prop>\n\t\t\t\t\t</d:set>\n\t\t\t\t\t</d:propertyupdate>`,\n\t\t},\n\t)\n}\n\nexport async function deleteVersion(version: Version) {\n\tawait client.deleteFile(version.filename)\n}\n","<!--\n - @copyright 2022 Carl Schwan <carl@carlschwan.eu>\n - @license AGPL-3.0-or-later\n -\n - This program is free software: you can redistribute it and/or modify\n - it under the terms of the GNU Affero General Public License as\n - published by the Free Software Foundation, either version 3 of the\n - License, or (at your option) any later version.\n -\n - This program is distributed in the hope that it will be useful,\n - but WITHOUT ANY WARRANTY; without even the implied warranty of\n - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n - GNU Affero General Public License for more details.\n -\n - You should have received a copy of the GNU Affero General Public License\n - along with this program. If not, see <http://www.gnu.org/licenses/>.\n -->\n<template>\n\t<NcListItem class=\"version\"\n\t\t:name=\"versionLabel\"\n\t\t:force-display-actions=\"true\"\n\t\tdata-files-versions-version\n\t\t@click=\"click\">\n\t\t<template #icon>\n\t\t\t<div v-if=\"!(loadPreview || previewLoaded)\" class=\"version__image\" />\n\t\t\t<img v-else-if=\"(isCurrent || version.hasPreview) && !previewErrored\"\n\t\t\t\t:src=\"version.previewUrl\"\n\t\t\t\talt=\"\"\n\t\t\t\tdecoding=\"async\"\n\t\t\t\tfetchpriority=\"low\"\n\t\t\t\tloading=\"lazy\"\n\t\t\t\tclass=\"version__image\"\n\t\t\t\t@load=\"previewLoaded = true\"\n\t\t\t\t@error=\"previewErrored = true\">\n\t\t\t<div v-else\n\t\t\t\tclass=\"version__image\">\n\t\t\t\t<ImageOffOutline :size=\"20\" />\n\t\t\t</div>\n\t\t</template>\n\t\t<template #subname>\n\t\t\t<div class=\"version__info\">\n\t\t\t\t<span :title=\"formattedDate\">{{ version.mtime | humanDateFromNow }}</span>\n\t\t\t\t<!-- Separate dot to improve alignement -->\n\t\t\t\t<span class=\"version__info__size\">â€¢</span>\n\t\t\t\t<span class=\"version__info__size\">{{ version.size | humanReadableSize }}</span>\n\t\t\t</div>\n\t\t</template>\n\t\t<template #actions>\n\t\t\t<NcActionButton v-if=\"enableLabeling\"\n\t\t\t\t:close-after-click=\"true\"\n\t\t\t\t@click=\"labelUpdate\">\n\t\t\t\t<template #icon>\n\t\t\t\t\t<Pencil :size=\"22\" />\n\t\t\t\t</template>\n\t\t\t\t{{ version.label === '' ? t('files_versions', 'Name this version') : t('files_versions', 'Edit version name') }}\n\t\t\t</NcActionButton>\n\t\t\t<NcActionButton v-if=\"!isCurrent && canView && canCompare\"\n\t\t\t\t:close-after-click=\"true\"\n\t\t\t\t@click=\"compareVersion\">\n\t\t\t\t<template #icon>\n\t\t\t\t\t<FileCompare :size=\"22\" />\n\t\t\t\t</template>\n\t\t\t\t{{ t('files_versions', 'Compare to current version') }}\n\t\t\t</NcActionButton>\n\t\t\t<NcActionButton v-if=\"!isCurrent\"\n\t\t\t\t:close-after-click=\"true\"\n\t\t\t\t@click=\"restoreVersion\">\n\t\t\t\t<template #icon>\n\t\t\t\t\t<BackupRestore :size=\"22\" />\n\t\t\t\t</template>\n\t\t\t\t{{ t('files_versions', 'Restore version') }}\n\t\t\t</NcActionButton>\n\t\t\t<NcActionLink :href=\"downloadURL\"\n\t\t\t\t:close-after-click=\"true\"\n\t\t\t\t:download=\"downloadURL\">\n\t\t\t\t<template #icon>\n\t\t\t\t\t<Download :size=\"22\" />\n\t\t\t\t</template>\n\t\t\t\t{{ t('files_versions', 'Download version') }}\n\t\t\t</NcActionLink>\n\t\t\t<NcActionButton v-if=\"!isCurrent && enableDeletion\"\n\t\t\t\t:close-after-click=\"true\"\n\t\t\t\t@click=\"deleteVersion\">\n\t\t\t\t<template #icon>\n\t\t\t\t\t<Delete :size=\"22\" />\n\t\t\t\t</template>\n\t\t\t\t{{ t('files_versions', 'Delete version') }}\n\t\t\t</NcActionButton>\n\t\t</template>\n\t</NcListItem>\n</template>\n\n<script>\nimport BackupRestore from 'vue-material-design-icons/BackupRestore.vue'\nimport Download from 'vue-material-design-icons/Download.vue'\nimport FileCompare from 'vue-material-design-icons/FileCompare.vue'\nimport Pencil from 'vue-material-design-icons/Pencil.vue'\nimport Delete from 'vue-material-design-icons/Delete.vue'\nimport ImageOffOutline from 'vue-material-design-icons/ImageOffOutline.vue'\nimport NcActionButton from '@nextcloud/vue/dist/Components/NcActionButton.js'\nimport NcActionLink from '@nextcloud/vue/dist/Components/NcActionLink.js'\nimport NcListItem from '@nextcloud/vue/dist/Components/NcListItem.js'\nimport Tooltip from '@nextcloud/vue/dist/Directives/Tooltip.js'\nimport moment from '@nextcloud/moment'\nimport { translate as t } from '@nextcloud/l10n'\nimport { joinPaths } from '@nextcloud/paths'\nimport { getRootUrl } from '@nextcloud/router'\nimport { loadState } from '@nextcloud/initial-state'\n\nexport default {\n\tname: 'Version',\n\tcomponents: {\n\t\tNcActionLink,\n\t\tNcActionButton,\n\t\tNcListItem,\n\t\tBackupRestore,\n\t\tDownload,\n\t\tFileCompare,\n\t\tPencil,\n\t\tDelete,\n\t\tImageOffOutline,\n\t},\n\tdirectives: {\n\t\ttooltip: Tooltip,\n\t},\n\tfilters: {\n\t\t/**\n\t\t * @param {number} bytes\n\t\t * @return {string}\n\t\t */\n\t\thumanReadableSize(bytes) {\n\t\t\treturn OC.Util.humanFileSize(bytes)\n\t\t},\n\t\t/**\n\t\t * @param {number} timestamp\n\t\t * @return {string}\n\t\t */\n\t\thumanDateFromNow(timestamp) {\n\t\t\treturn moment(timestamp).fromNow()\n\t\t},\n\t},\n\tprops: {\n\t\t/** @type {Vue.PropOptions<import('../utils/versions.ts').Version>} */\n\t\tversion: {\n\t\t\ttype: Object,\n\t\t\trequired: true,\n\t\t},\n\t\tfileInfo: {\n\t\t\ttype: Object,\n\t\t\trequired: true,\n\t\t},\n\t\tisCurrent: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: false,\n\t\t},\n\t\tisFirstVersion: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: false,\n\t\t},\n\t\tloadPreview: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: false,\n\t\t},\n\t\tcanView: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: false,\n\t\t},\n\t\tcanCompare: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: false,\n\t\t},\n\t},\n\tdata() {\n\t\treturn {\n\t\t\tpreviewLoaded: false,\n\t\t\tpreviewErrored: false,\n\t\t\tcapabilities: loadState('core', 'capabilities', { files: { version_labeling: false, version_deletion: false } }),\n\t\t}\n\t},\n\tcomputed: {\n\t\t/**\n\t\t * @return {string}\n\t\t */\n\t\tversionLabel() {\n\t\t\tconst label = this.version.label ?? ''\n\n\t\t\tif (this.isCurrent) {\n\t\t\t\tif (label === '') {\n\t\t\t\t\treturn t('files_versions', 'Current version')\n\t\t\t\t} else {\n\t\t\t\t\treturn `${label} (${t('files_versions', 'Current version')})`\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (this.isFirstVersion && label === '') {\n\t\t\t\treturn t('files_versions', 'Initial version')\n\t\t\t}\n\n\t\t\treturn label\n\t\t},\n\n\t\t/**\n\t\t * @return {string}\n\t\t */\n\t\tdownloadURL() {\n\t\t\tif (this.isCurrent) {\n\t\t\t\treturn getRootUrl() + joinPaths('/remote.php/webdav', this.fileInfo.path, this.fileInfo.name)\n\t\t\t} else {\n\t\t\t\treturn getRootUrl() + this.version.url\n\t\t\t}\n\t\t},\n\n\t\t/** @return {string} */\n\t\tformattedDate() {\n\t\t\treturn moment(this.version.mtime).format('LLL')\n\t\t},\n\n\t\t/** @return {boolean} */\n\t\tenableLabeling() {\n\t\t\treturn this.capabilities.files.version_labeling === true\n\t\t},\n\n\t\t/** @return {boolean} */\n\t\tenableDeletion() {\n\t\t\treturn this.capabilities.files.version_deletion === true\n\t\t},\n\t},\n\tmethods: {\n\t\tlabelUpdate() {\n\t\t\tthis.$emit('label-update-request')\n\t\t},\n\n\t\trestoreVersion() {\n\t\t\tthis.$emit('restore', this.version)\n\t\t},\n\n\t\tdeleteVersion() {\n\t\t\tthis.$emit('delete', this.version)\n\t\t},\n\n\t\tclick() {\n\t\t\tif (!this.canView) {\n\t\t\t\twindow.location = this.downloadURL\n\t\t\t\treturn\n\t\t\t}\n\t\t\tthis.$emit('click', { version: this.version })\n\t\t},\n\n\t\tcompareVersion() {\n\t\t\tif (!this.canView) {\n\t\t\t\tthrow new Error('Cannot compare version of this file')\n\t\t\t}\n\t\t\tthis.$emit('compare', { version: this.version })\n\t\t},\n\n\t\tt,\n\t},\n}\n</script>\n\n<style scoped lang=\"scss\">\n.version {\n\tdisplay: flex;\n\tflex-direction: row;\n\n\t&__info {\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\talign-items: center;\n\t\tgap: 0.5rem;\n\n\t\t&__size {\n\t\t\tcolor: var(--color-text-lighter);\n\t\t}\n\t}\n\n\t&__image {\n\t\twidth: 3rem;\n\t\theight: 3rem;\n\t\tborder: 1px solid var(--color-border);\n\t\tborder-radius: var(--border-radius-large);\n\n\t\t// Useful to display no preview icon.\n\t\tdisplay: flex;\n\t\tjustify-content: center;\n\t\tcolor: var(--color-text-light);\n\t}\n}\n</style>\n","<!--\n - @copyright Copyright (c) 2022 Louis Chemineau <louis@chmn.me>\n -\n - @author Louis Chemineau <louis@chmn.me>\n -\n - @license AGPL-3.0-or-later\n -\n - This program is free software: you can redistribute it and/or modify\n - it under the terms of the GNU Affero General Public License as\n - published by the Free Software Foundation, either version 3 of the\n - License, or (at your option) any later version.\n -\n - This program is distributed in the hope that it will be useful,\n - but WITHOUT ANY WARRANTY; without even the implied warranty of\n - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n - GNU Affero General Public License for more details.\n -\n - You should have received a copy of the GNU Affero General Public License\n - along with this program. If not, see <http://www.gnu.org/licenses/>.\n -\n -->\n<template>\n\t<div v-if=\"!useWindow && containerElement === null\" ref=\"container\" class=\"vs-container\">\n\t\t<div ref=\"rowsContainer\"\n\t\t\tclass=\"vs-rows-container\"\n\t\t\t:style=\"rowsContainerStyle\">\n\t\t\t<slot :visible-sections=\"visibleSections\" />\n\t\t\t<slot name=\"loader\" />\n\t\t</div>\n\t</div>\n\t<div v-else\n\t\tref=\"rowsContainer\"\n\t\tclass=\"vs-rows-container\"\n\t\t:style=\"rowsContainerStyle\">\n\t\t<slot :visible-sections=\"visibleSections\" />\n\t\t<slot name=\"loader\" />\n\t</div>\n</template>\n\n<script lang=\"ts\">\nimport { defineComponent, type PropType } from 'vue'\n\nimport logger from '../utils/logger.js'\n\ninterface RowItem {\n\tid: string // Unique id for the item.\n\tkey?: string // Unique key for the item.\n}\n\ninterface Row {\n\tkey: string // Unique key for the row.\n\theight: number // The height of the row.\n\tsectionKey: string // Unique key for the row.\n\titems: RowItem[] // List of items in the row.\n}\n\ninterface VisibleRow extends Row {\n\tdistance: number // The distance from the visible viewport\n}\n\ninterface Section {\n\tkey: string, // Unique key for the section.\n\trows: Row[], // The height of the row.\n\theight: number, // Height of the section, excluding the header.\n}\n\ninterface VisibleSection extends Section {\n\trows: VisibleRow[], // The height of the row.\n}\n\nexport default defineComponent({\n\tname: 'VirtualScrolling',\n\n\tprops: {\n\t\tsections: {\n\t\t\ttype: Array as PropType<Section[]>,\n\t\t\trequired: true,\n\t\t},\n\n\t\tcontainerElement: {\n\t\t\ttype: HTMLElement,\n\t\t\tdefault: null,\n\t\t},\n\n\t\tuseWindow: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: false,\n\t\t},\n\n\t\theaderHeight: {\n\t\t\ttype: Number,\n\t\t\tdefault: 75,\n\t\t},\n\t\trenderDistance: {\n\t\t\ttype: Number,\n\t\t\tdefault: 0.5,\n\t\t},\n\t\tbottomBufferRatio: {\n\t\t\ttype: Number,\n\t\t\tdefault: 2,\n\t\t},\n\t\tscrollToKey: {\n\t\t\ttype: String,\n\t\t\tdefault: '',\n\t\t},\n\t},\n\n\tdata() {\n\t\treturn {\n\t\t\tscrollPosition: 0,\n\t\t\tcontainerHeight: 0,\n\t\t\trowsContainerHeight: 0,\n\t\t\tresizeObserver: null as ResizeObserver|null,\n\t\t}\n\t},\n\n\tcomputed: {\n\t\tvisibleSections(): VisibleSection[] {\n\t\t\tlogger.debug('[VirtualScrolling] Computing visible section', { sections: this.sections })\n\n\t\t\t// Optimization: get those computed properties once to not go through vue's internal every time we need them.\n\t\t\tconst containerHeight = this.containerHeight\n\t\t\tconst containerTop = this.scrollPosition\n\t\t\tconst containerBottom = containerTop + containerHeight\n\n\t\t\tlet currentRowTop = 0\n\t\t\tlet currentRowBottom = 0\n\n\t\t\t// Compute whether a row should be included in the DOM (shouldRender)\n\t\t\t// And how visible the row is.\n\t\t\tconst visibleSections = this.sections\n\t\t\t\t.map(section => {\n\t\t\t\t\tcurrentRowBottom += this.headerHeight\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\t...section,\n\t\t\t\t\t\trows: section.rows.reduce((visibleRows, row) => {\n\t\t\t\t\t\t\tcurrentRowTop = currentRowBottom\n\t\t\t\t\t\t\tcurrentRowBottom += row.height\n\n\t\t\t\t\t\t\tlet distance = 0\n\n\t\t\t\t\t\t\tif (currentRowBottom < containerTop) {\n\t\t\t\t\t\t\t\tdistance = (containerTop - currentRowBottom) / containerHeight\n\t\t\t\t\t\t\t} else if (currentRowTop > containerBottom) {\n\t\t\t\t\t\t\t\tdistance = (currentRowTop - containerBottom) / containerHeight\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (distance > this.renderDistance) {\n\t\t\t\t\t\t\t\treturn visibleRows\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treturn [\n\t\t\t\t\t\t\t\t...visibleRows,\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t...row,\n\t\t\t\t\t\t\t\t\tdistance,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t]\n\t\t\t\t\t\t}, [] as VisibleRow[]),\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.filter(section => section.rows.length > 0)\n\n\t\t\t// To allow vue to recycle the DOM elements instead of adding and deleting new ones,\n\t\t\t// we assign a random key to each items. When a item removed, we recycle its key for new items,\n\t\t\t// so vue can replace the content of removed DOM elements with the content of new items, but keep the other DOM elements untouched.\n\t\t\tconst visibleItems = visibleSections\n\t\t\t\t.flatMap(({ rows }) => rows)\n\t\t\t\t.flatMap(({ items }) => items)\n\n\t\t\tconst rowIdToKeyMap = this._rowIdToKeyMap as {[key: string]: string}\n\n\t\t\tvisibleItems.forEach(item => (item.key = rowIdToKeyMap[item.id]))\n\n\t\t\tconst usedTokens = visibleItems\n\t\t\t\t.map(({ key }) => key)\n\t\t\t\t.filter(key => key !== undefined)\n\n\t\t\tconst unusedTokens = Object.values(rowIdToKeyMap).filter(key => !usedTokens.includes(key))\n\n\t\t\tvisibleItems\n\t\t\t\t.filter(({ key }) => key === undefined)\n\t\t\t\t.forEach(item => (item.key = unusedTokens.pop() ?? Math.random().toString(36).substr(2)))\n\n\t\t\t// this._rowIdToKeyMap is created in the beforeCreate hook, so value changes are not tracked.\n\t\t\t// Therefore, we wont trigger the computation of visibleSections again if we alter the value of this._rowIdToKeyMap.\n\t\t\t// eslint-disable-next-line vue/no-side-effects-in-computed-properties\n\t\t\tthis._rowIdToKeyMap = visibleItems.reduce((finalMapping, { id, key }) => ({ ...finalMapping, [`${id}`]: key }), {})\n\n\t\t\treturn visibleSections\n\t\t},\n\n\t\t/**\n\t\t * Total height of all the rows + some room for the loader.\n\t\t */\n\t\ttotalHeight(): number {\n\t\t\tconst loaderHeight = 0\n\n\t\t\treturn this.sections\n\t\t\t\t.map(section => this.headerHeight + section.height)\n\t\t\t\t.reduce((totalHeight, sectionHeight) => totalHeight + sectionHeight, 0) + loaderHeight\n\t\t},\n\n\t\tpaddingTop(): number {\n\t\t\tif (this.visibleSections.length === 0) {\n\t\t\t\treturn 0\n\t\t\t}\n\n\t\t\tlet paddingTop = 0\n\n\t\t\tfor (const section of this.sections) {\n\t\t\t\tif (section.key !== this.visibleSections[0].rows[0].sectionKey) {\n\t\t\t\t\tpaddingTop += this.headerHeight + section.height\n\t\t\t\t\tcontinue\n\t\t\t\t}\n\n\t\t\t\tfor (const row of section.rows) {\n\t\t\t\t\tif (row.key === this.visibleSections[0].rows[0].key) {\n\t\t\t\t\t\treturn paddingTop\n\t\t\t\t\t}\n\n\t\t\t\t\tpaddingTop += row.height\n\t\t\t\t}\n\n\t\t\t\tpaddingTop += this.headerHeight\n\t\t\t}\n\n\t\t\treturn paddingTop\n\t\t},\n\n\t\t/**\n\t\t * padding-top is used to replace not included item in the container.\n\t\t */\n\t\trowsContainerStyle(): { height: string; paddingTop: string } {\n\t\t\treturn {\n\t\t\t\theight: `${this.totalHeight}px`,\n\t\t\t\tpaddingTop: `${this.paddingTop}px`,\n\t\t\t}\n\t\t},\n\n\t\t/**\n\t\t * Whether the user is near the bottom.\n\t\t * If true, then the need-content event will be emitted.\n\t\t */\n\t\tisNearBottom(): boolean {\n\t\t\tconst buffer = this.containerHeight * this.bottomBufferRatio\n\t\t\treturn this.scrollPosition + this.containerHeight >= this.totalHeight - buffer\n\t\t},\n\n\t\tcontainer() {\n\t\t\tlogger.debug('[VirtualScrolling] Computing container')\n\t\t\tif (this.containerElement !== null) {\n\t\t\t\treturn this.containerElement\n\t\t\t} else if (this.useWindow) {\n\t\t\t\treturn window\n\t\t\t} else {\n\t\t\t\treturn this.$refs.container as Element\n\t\t\t}\n\t\t},\n\t},\n\n\twatch: {\n\t\tisNearBottom(value) {\n\t\t\tlogger.debug('[VirtualScrolling] isNearBottom changed', { value })\n\t\t\tif (value) {\n\t\t\t\tthis.$emit('need-content')\n\t\t\t}\n\t\t},\n\n\t\tvisibleSections() {\n\t\t\t// Re-emit need-content when rows is updated and isNearBottom is still true.\n\t\t\t// If the height of added rows is under `bottomBufferRatio`, `isNearBottom` will still be true so we need more content.\n\t\t\tif (this.isNearBottom) {\n\t\t\t\tthis.$emit('need-content')\n\t\t\t}\n\t\t},\n\n\t\tscrollToKey(key) {\n\t\t\tlet currentRowTopDistanceFromTop = 0\n\n\t\t\tfor (const section of this.sections) {\n\t\t\t\tif (section.key !== key) {\n\t\t\t\t\tcurrentRowTopDistanceFromTop += this.headerHeight + section.height\n\t\t\t\t\tcontinue\n\t\t\t\t}\n\n\t\t\t\tbreak\n\t\t\t}\n\n\t\t\tlogger.debug('[VirtualScrolling] Scrolling to', { currentRowTopDistanceFromTop })\n\t\t\tthis.container.scrollTo({ top: currentRowTopDistanceFromTop, behavior: 'smooth' })\n\t\t},\n\t},\n\n\tbeforeCreate() {\n\t\tthis._rowIdToKeyMap = {}\n\t},\n\n\tmounted() {\n\t\tthis.resizeObserver = new ResizeObserver(entries => {\n\t\t\tfor (const entry of entries) {\n\t\t\t\tconst cr = entry.contentRect\n\t\t\t\tif (entry.target === this.container) {\n\t\t\t\t\tthis.containerHeight = cr.height\n\t\t\t\t}\n\t\t\t\tif (entry.target.classList.contains('vs-rows-container')) {\n\t\t\t\t\tthis.rowsContainerHeight = cr.height\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\n\t\tif (this.useWindow) {\n\t\t\twindow.addEventListener('resize', this.updateContainerSize, { passive: true })\n\t\t\tthis.containerHeight = window.innerHeight\n\t\t} else {\n\t\t\tthis.resizeObserver.observe(this.container as HTMLElement|Element)\n\t\t}\n\n\t\tthis.resizeObserver.observe(this.$refs.rowsContainer as Element)\n\t\tthis.container.addEventListener('scroll', this.updateScrollPosition, { passive: true })\n\t},\n\n\tbeforeDestroy() {\n\t\tif (this.useWindow) {\n\t\t\twindow.removeEventListener('resize', this.updateContainerSize)\n\t\t}\n\n\t\tthis.resizeObserver?.disconnect()\n\t\tthis.container.removeEventListener('scroll', this.updateScrollPosition)\n\t},\n\n\tmethods: {\n\t\tupdateScrollPosition() {\n\t\t\tthis._onScrollHandle ??= requestAnimationFrame(() => {\n\t\t\t\tthis._onScrollHandle = null\n\t\t\t\tif (this.useWindow) {\n\t\t\t\t\tthis.scrollPosition = (this.container as Window).scrollY\n\t\t\t\t} else {\n\t\t\t\t\tthis.scrollPosition = (this.container as HTMLElement|Element).scrollTop\n\t\t\t\t}\n\t\t\t})\n\t\t},\n\n\t\tupdateContainerSize() {\n\t\t\tthis.containerHeight = window.innerHeight\n\t\t},\n\t},\n})\n</script>\n\n<style scoped lang=\"scss\">\n.vs-container {\n\toverflow-y: scroll;\n\theight: 100%;\n}\n\n.vs-rows-container {\n\tbox-sizing: border-box;\n\twill-change: scroll-position, padding;\n\tcontain: layout paint style;\n}\n</style>\n","<!--\n - @copyright Copyright (c) 2024 Louis Chemineau <louis@chmn.me>\n -\n - @author Louis Chemineau <louis@chmn.me>\n -\n - @license AGPL-3.0-or-later\n -\n - This program is free software: you can redistribute it and/or modify\n - it under the terms of the GNU Affero General Public License as\n - published by the Free Software Foundation, either version 3 of the\n - License, or (at your option) any later version.\n -\n - This program is distributed in the hope that it will be useful,\n - but WITHOUT ANY WARRANTY; without even the implied warranty of\n - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n - GNU Affero General Public License for more details.\n -\n - You should have received a copy of the GNU Affero General Public License\n - along with this program. If not, see <http://www.gnu.org/licenses/>.\n -->\n<template>\n\t<form class=\"version-label-modal\"\n\t\t@submit.prevent=\"setVersionLabel(innerVersionLabel)\">\n\t\t<label>\n\t\t\t<div class=\"version-label-modal__title\">{{ t('files_versions', 'Version name') }}</div>\n\t\t\t<NcTextField ref=\"labelInput\"\n\t\t\t\t:value.sync=\"innerVersionLabel\"\n\t\t\t\t:placeholder=\"t('files_versions', 'Version name')\"\n\t\t\t\t:label-outside=\"true\" />\n\t\t</label>\n\n\t\t<div class=\"version-label-modal__info\">\n\t\t\t{{ t('files_versions', 'Named versions are persisted, and excluded from automatic cleanups when your storage quota is full.') }}\n\t\t</div>\n\n\t\t<div class=\"version-label-modal__actions\">\n\t\t\t<NcButton :disabled=\"innerVersionLabel.trim().length === 0\" @click=\"setVersionLabel('')\">\n\t\t\t\t{{ t('files_versions', 'Remove version name') }}\n\t\t\t</NcButton>\n\t\t\t<NcButton type=\"primary\" native-type=\"submit\">\n\t\t\t\t<template #icon>\n\t\t\t\t\t<Check />\n\t\t\t\t</template>\n\t\t\t\t{{ t('files_versions', 'Save version name') }}\n\t\t\t</NcButton>\n\t\t</div>\n\t</form>\n</template>\n\n<script lang=\"ts\">\nimport Check from 'vue-material-design-icons/Check.vue'\nimport NcButton from '@nextcloud/vue/dist/Components/NcButton.js'\nimport NcTextField from '@nextcloud/vue/dist/Components/NcTextField.js'\nimport { translate } from '@nextcloud/l10n'\n\nimport { defineComponent } from 'vue'\n\nexport default defineComponent({\n\tname: 'VersionLabelForm',\n\tcomponents: {\n\t\tNcButton,\n\t\tNcTextField,\n\t\tCheck,\n\t},\n\tprops: {\n\t\tversionLabel: {\n\t\t\ttype: String,\n\t\t\tdefault: '',\n\t\t},\n\t},\n\tdata() {\n\t\treturn {\n\t\t\tinnerVersionLabel: this.versionLabel,\n\t\t}\n\t},\n\tmounted() {\n\t\tthis.$nextTick(() => {\n\t\t\t(this.$refs.labelInput as Vue).$el.getElementsByTagName('input')[0].focus()\n\t\t})\n\t},\n\tmethods: {\n\t\tsetVersionLabel(label: string) {\n\t\t\tthis.$emit('label-update', label)\n\t\t},\n\n\t\tt: translate,\n\t},\n})\n</script>\n\n<style scoped lang=\"scss\">\n.version-label-modal {\n\tdisplay: flex;\n\tjustify-content: space-between;\n\tflex-direction: column;\n\theight: 250px;\n\tpadding: 16px;\n\n\t&__title {\n\t\tmargin-bottom: 12px;\n\t\tfont-weight: 600;\n\t}\n\n\t&__info {\n\t\tmargin-top: 12px;\n\t\tcolor: var(--color-text-maxcontrast);\n\t}\n\n\t&__actions {\n\t\tdisplay: flex;\n\t\tjustify-content: space-between;\n\t\tmargin-top: 64px;\n\t}\n}\n</style>\n","<!--\n - @copyright 2022 Carl Schwan <carl@carlschwan.eu>\n - @license AGPL-3.0-or-later\n -\n - This program is free software: you can redistribute it and/or modify\n - it under the terms of the GNU Affero General Public License as\n - published by the Free Software Foundation, either version 3 of the\n - License, or (at your option) any later version.\n -\n - This program is distributed in the hope that it will be useful,\n - but WITHOUT ANY WARRANTY; without even the implied warranty of\n - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n - GNU Affero General Public License for more details.\n -\n - You should have received a copy of the GNU Affero General Public License\n - along with this program. If not, see <http://www.gnu.org/licenses/>.\n -->\n<template>\n\t<div class=\"versions-tab__container\">\n\t\t<VirtualScrolling :sections=\"sections\"\n\t\t\t:header-height=\"0\">\n\t\t\t<template slot-scope=\"{visibleSections}\">\n\t\t\t\t<ul data-files-versions-versions-list>\n\t\t\t\t\t<template v-if=\"visibleSections.length === 1\">\n\t\t\t\t\t\t<Version v-for=\"(row) of visibleSections[0].rows\"\n\t\t\t\t\t\t\t:key=\"row.items[0].mtime\"\n\t\t\t\t\t\t\t:can-view=\"canView\"\n\t\t\t\t\t\t\t:can-compare=\"canCompare\"\n\t\t\t\t\t\t\t:load-preview=\"isActive\"\n\t\t\t\t\t\t\t:version=\"row.items[0]\"\n\t\t\t\t\t\t\t:file-info=\"fileInfo\"\n\t\t\t\t\t\t\t:is-current=\"row.items[0].mtime === fileInfo.mtime\"\n\t\t\t\t\t\t\t:is-first-version=\"row.items[0].mtime === initialVersionMtime\"\n\t\t\t\t\t\t\t@click=\"openVersion\"\n\t\t\t\t\t\t\t@compare=\"compareVersion\"\n\t\t\t\t\t\t\t@restore=\"handleRestore\"\n\t\t\t\t\t\t\t@label-update-request=\"handleLabelUpdateRequest(row.items[0])\"\n\t\t\t\t\t\t\t@delete=\"handleDelete\" />\n\t\t\t\t\t</template>\n\t\t\t\t</ul>\n\t\t\t</template>\n\t\t\t<NcLoadingIcon v-if=\"loading\" slot=\"loader\" class=\"files-list-viewer__loader\" />\n\t\t</VirtualScrolling>\n\t\t<NcModal v-if=\"showVersionLabelForm\"\n\t\t\t:title=\"t('files_versions', 'Name this version')\"\n\t\t\t@close=\"showVersionLabelForm = false\">\n\t\t\t<VersionLabelForm :version-label=\"editedVersion.label\" @label-update=\"handleLabelUpdate\" />\n\t\t</NcModal>\n\t</div>\n</template>\n\n<script>\nimport path from 'path'\n\nimport { showError, showSuccess } from '@nextcloud/dialogs'\nimport isMobile from '@nextcloud/vue/dist/Mixins/isMobile.js'\nimport { emit, subscribe, unsubscribe } from '@nextcloud/event-bus'\nimport { getCurrentUser } from '@nextcloud/auth'\nimport NcLoadingIcon from '@nextcloud/vue/dist/Components/NcLoadingIcon.js'\nimport NcModal from '@nextcloud/vue/dist/Components/NcModal.js'\n\nimport { fetchVersions, deleteVersion, restoreVersion, setVersionLabel } from '../utils/versions.ts'\nimport Version from '../components/Version.vue'\nimport VirtualScrolling from '../components/VirtualScrolling.vue'\nimport VersionLabelForm from '../components/VersionLabelForm.vue'\n\nexport default {\n\tname: 'VersionTab',\n\tcomponents: {\n\t\tVersion,\n\t\tVirtualScrolling,\n\t\tVersionLabelForm,\n\t\tNcLoadingIcon,\n\t\tNcModal,\n\t},\n\tmixins: [\n\t\tisMobile,\n\t],\n\tdata() {\n\t\treturn {\n\t\t\tfileInfo: null,\n\t\t\tisActive: false,\n\t\t\t/** @type {import('../utils/versions.ts').Version[]} */\n\t\t\tversions: [],\n\t\t\tloading: false,\n\t\t\tshowVersionLabelForm: false,\n\t\t}\n\t},\n\tcomputed: {\n\t\tsections() {\n\t\t\tconst rows = this.orderedVersions.map(version => ({ key: version.mtime, height: 68, sectionKey: 'versions', items: [version] }))\n\t\t\treturn [{ key: 'versions', rows, height: 68 * this.orderedVersions.length }]\n\t\t},\n\n\t\t/**\n\t\t * Order versions by mtime.\n\t\t * Put the current version at the top.\n\t\t *\n\t\t * @return {import('../utils/versions.ts').Version[]}\n\t\t */\n\t\torderedVersions() {\n\t\t\treturn [...this.versions].sort((a, b) => {\n\t\t\t\tif (a.mtime === this.fileInfo.mtime) {\n\t\t\t\t\treturn -1\n\t\t\t\t} else if (b.mtime === this.fileInfo.mtime) {\n\t\t\t\t\treturn 1\n\t\t\t\t} else {\n\t\t\t\t\treturn b.mtime - a.mtime\n\t\t\t\t}\n\t\t\t})\n\t\t},\n\n\t\t/**\n\t\t * Return the mtime of the first version to display \"Initial version\" label\n\t\t *\n\t\t * @return {number}\n\t\t */\n\t\tinitialVersionMtime() {\n\t\t\treturn this.versions\n\t\t\t\t.map(version => version.mtime)\n\t\t\t\t.reduce((a, b) => Math.min(a, b))\n\t\t},\n\n\t\tviewerFileInfo() {\n\t\t\t// We need to remap bitmask to dav permissions as the file info we have is converted through client.js\n\t\t\tlet davPermissions = ''\n\t\t\tif (this.fileInfo.permissions & 1) {\n\t\t\t\tdavPermissions += 'R'\n\t\t\t}\n\t\t\tif (this.fileInfo.permissions & 2) {\n\t\t\t\tdavPermissions += 'W'\n\t\t\t}\n\t\t\tif (this.fileInfo.permissions & 8) {\n\t\t\t\tdavPermissions += 'D'\n\t\t\t}\n\t\t\treturn {\n\t\t\t\t...this.fileInfo,\n\t\t\t\tmime: this.fileInfo.mimetype,\n\t\t\t\tbasename: this.fileInfo.name,\n\t\t\t\tfilename: this.fileInfo.path + '/' + this.fileInfo.name,\n\t\t\t\tpermissions: davPermissions,\n\t\t\t\tfileid: this.fileInfo.id,\n\t\t\t}\n\t\t},\n\n\t\t/** @return {boolean} */\n\t\tcanView() {\n\t\t\treturn window.OCA.Viewer?.mimetypesCompare?.includes(this.fileInfo.mimetype)\n\t\t},\n\n\t\tcanCompare() {\n\t\t\treturn !this.isMobile\n\t\t},\n\t},\n\tmounted() {\n\t\tsubscribe('files_versions:restore:restored', this.fetchVersions)\n\t},\n\tbeforeUnmount() {\n\t\tunsubscribe('files_versions:restore:restored', this.fetchVersions)\n\t},\n\tmethods: {\n\t\t/**\n\t\t * Update current fileInfo and fetch new data\n\t\t *\n\t\t * @param {object} fileInfo the current file FileInfo\n\t\t */\n\t\tasync update(fileInfo) {\n\t\t\tthis.fileInfo = fileInfo\n\t\t\tthis.resetState()\n\t\t\tthis.fetchVersions()\n\t\t},\n\n\t\t/**\n\t\t * @param {boolean} isActive whether the tab is active\n\t\t */\n\t\tasync setIsActive(isActive) {\n\t\t\tthis.isActive = isActive\n\t\t},\n\n\t\t/**\n\t\t * Get the existing versions infos\n\t\t */\n\t\tasync fetchVersions() {\n\t\t\ttry {\n\t\t\t\tthis.loading = true\n\t\t\t\tthis.versions = await fetchVersions(this.fileInfo)\n\t\t\t} finally {\n\t\t\t\tthis.loading = false\n\t\t\t}\n\t\t},\n\n\t\t/**\n\t\t * Handle restored event from Version.vue\n\t\t *\n\t\t * @param {import('../utils/versions.ts').Version} version\n\t\t */\n\t\tasync handleRestore(version) {\n\t\t\t// Update local copy of fileInfo as rendering depends on it.\n\t\t\tconst oldFileInfo = this.fileInfo\n\t\t\tthis.fileInfo = {\n\t\t\t\t...this.fileInfo,\n\t\t\t\tsize: version.size,\n\t\t\t\tmtime: version.mtime,\n\t\t\t}\n\n\t\t\tconst restoreStartedEventState = {\n\t\t\t\tpreventDefault: false,\n\t\t\t\tfileInfo: this.fileInfo,\n\t\t\t\tversion,\n\t\t\t}\n\t\t\temit('files_versions:restore:requested', restoreStartedEventState)\n\t\t\tif (restoreStartedEventState.preventDefault) {\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tawait restoreVersion(version)\n\t\t\t\tif (version.label !== '') {\n\t\t\t\t\tshowSuccess(t('files_versions', `${version.label} restored`))\n\t\t\t\t} else if (version.mtime === this.initialVersionMtime) {\n\t\t\t\t\tshowSuccess(t('files_versions', 'Initial version restored'))\n\t\t\t\t} else {\n\t\t\t\t\tshowSuccess(t('files_versions', 'Version restored'))\n\t\t\t\t}\n\t\t\t\temit('files_versions:restore:restored', version)\n\t\t\t} catch (exception) {\n\t\t\t\tthis.fileInfo = oldFileInfo\n\t\t\t\tshowError(t('files_versions', 'Could not restore version'))\n\t\t\t\temit('files_versions:restore:failed', version)\n\t\t\t}\n\t\t},\n\n\t\t/**\n\t\t * Handle label-updated event from Version.vue\n\t\t * @param {import('../utils/versions.ts').Version} version\n\t\t */\n\t\thandleLabelUpdateRequest(version) {\n\t\t\tthis.showVersionLabelForm = true\n\t\t\tthis.editedVersion = version\n\t\t},\n\n\t\t/**\n\t\t * Handle label-updated event from Version.vue\n\t\t * @param {string} newLabel\n\t\t */\n\t\tasync handleLabelUpdate(newLabel) {\n\t\t\tconst oldLabel = this.editedVersion.label\n\t\t\tthis.editedVersion.label = newLabel\n\t\t\tthis.showVersionLabelForm = false\n\n\t\t\ttry {\n\t\t\t\tawait setVersionLabel(this.editedVersion, newLabel)\n\t\t\t\tthis.editedVersion = null\n\t\t\t} catch (exception) {\n\t\t\t\tthis.editedVersion.label = oldLabel\n\t\t\t\tshowError(this.t('files_versions', 'Could not set version label'))\n\t\t\t\tlogger.error('Could not set version label', { exception })\n\t\t\t}\n\t\t},\n\n\t\t/**\n\t\t * Handle deleted event from Version.vue\n\t\t *\n\t\t * @param {import('../utils/versions.ts').Version} version\n\t\t * @param {string} newName\n\t\t */\n\t\tasync handleDelete(version) {\n\t\t\tconst index = this.versions.indexOf(version)\n\t\t\tthis.versions.splice(index, 1)\n\n\t\t\ttry {\n\t\t\t\tawait deleteVersion(version)\n\t\t\t} catch (exception) {\n\t\t\t\tthis.versions.push(version)\n\t\t\t\tshowError(t('files_versions', 'Could not delete version'))\n\t\t\t}\n\t\t},\n\n\t\t/**\n\t\t * Reset the current view to its default state\n\t\t */\n\t\tresetState() {\n\t\t\tthis.$set(this, 'versions', [])\n\t\t},\n\n\t\topenVersion({ version }) {\n\t\t\t// Open current file view instead of read only\n\t\t\tif (version.mtime === this.fileInfo.mtime) {\n\t\t\t\tOCA.Viewer.open({ fileInfo: this.viewerFileInfo })\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\t// Versions previews are too small for our use case, so we override hasPreview and previewUrl\n\t\t\t// which makes the viewer render the original file.\n\t\t\t// We also point to the original filename if the version is the current one.\n\t\t\tconst versions = this.versions.map(version => ({\n\t\t\t\t...version,\n\t\t\t\tfilename: version.mtime === this.fileInfo.mtime ? path.join('files', getCurrentUser()?.uid ?? '', this.fileInfo.path, this.fileInfo.name) : version.filename,\n\t\t\t\thasPreview: false,\n\t\t\t\tpreviewUrl: undefined,\n\t\t\t}))\n\n\t\t\tOCA.Viewer.open({\n\t\t\t\tfileInfo: versions.find(v => v.source === version.source),\n\t\t\t\tenableSidebar: false,\n\t\t\t})\n\t\t},\n\n\t\tcompareVersion({ version }) {\n\t\t\tconst versions = this.versions.map(version => ({ ...version, hasPreview: false, previewUrl: undefined }))\n\n\t\t\tOCA.Viewer.compare(this.viewerFileInfo, versions.find(v => v.source === version.source))\n\t\t},\n\t},\n}\n</script>\n<style lang=\"scss\">\n.versions-tab__container {\n\theight: 100%;\n}\n</style>\n","/**\n * @copyright 2022 Carl Schwan <carl@carlschwan.eu>\n * @license AGPL-3.0-or-later\n *\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n *\n */\n\nimport Vue from 'vue'\nimport { translate as t, translatePlural as n } from '@nextcloud/l10n'\n\nimport VersionTab from './views/VersionTab.vue'\nimport VTooltip from 'v-tooltip'\n// eslint-disable-next-line n/no-missing-import, import/no-unresolved\nimport BackupRestore from '@mdi/svg/svg/backup-restore.svg?raw'\n\nVue.prototype.t = t\nVue.prototype.n = n\n\nVue.use(VTooltip)\n\n// Init Sharing tab component\nconst View = Vue.extend(VersionTab)\nlet TabInstance = null\n\nwindow.addEventListener('DOMContentLoaded', function() {\n\tif (OCA.Files?.Sidebar === undefined) {\n\t\treturn\n\t}\n\n\tOCA.Files.Sidebar.registerTab(new OCA.Files.Sidebar.Tab({\n\t\tid: 'version_vue',\n\t\tname: t('files_versions', 'Versions'),\n\t\ticonSvg: BackupRestore,\n\n\t\tasync mount(el, fileInfo, context) {\n\t\t\tif (TabInstance) {\n\t\t\t\tTabInstance.$destroy()\n\t\t\t}\n\t\t\tTabInstance = new View({\n\t\t\t\t// Better integration with vue parent component\n\t\t\t\tparent: context,\n\t\t\t})\n\t\t\t// Only mount after we have all the info we need\n\t\t\tawait TabInstance.update(fileInfo)\n\t\t\tTabInstance.$mount(el)\n\t\t},\n\t\tupdate(fileInfo) {\n\t\t\tTabInstance.update(fileInfo)\n\t\t},\n\t\tsetIsActive(isActive) {\n\t\t\tif (!TabInstance) {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tTabInstance.setIsActive(isActive)\n\t\t},\n\t\tdestroy() {\n\t\t\tTabInstance.$destroy()\n\t\t\tTabInstance = null\n\t\t},\n\t\tenabled(fileInfo) {\n\t\t\treturn !(fileInfo?.isDirectory() ?? true)\n\t\t},\n\t}))\n})\n"],"names":["rootPath","remote","generateRemoteUrl","createClient","getRequestToken","davRequest","logger$1","getLoggerBuilder","fetchVersions","fileInfo","_a","path","getCurrentUser","client","mime","version","formatVersion","exception","logger","restoreVersion","_b","mtime","moment","previewUrl","generateUrl","joinPaths","encodeFilePath","setVersionLabel","newLabel","deleteVersion","_sfc_main","NcActionLink","NcActionButton","NcListItem","BackupRestore","Download","FileCompare","Pencil","Delete","ImageOffOutline","Tooltip","bytes","timestamp","loadState","label","t","getRootUrl","_sfc_main$2","defineComponent","containerHeight","containerTop","containerBottom","currentRowTop","currentRowBottom","visibleSections","section","visibleRows","row","distance","visibleItems","rows","items","rowIdToKeyMap","item","usedTokens","key","unusedTokens","finalMapping","id","totalHeight","sectionHeight","paddingTop","buffer","value","currentRowTopDistanceFromTop","entries","entry","cr","_sfc_main$1","NcButton","NcTextField","Check","translate","Version","VirtualScrolling","VersionLabelForm","NcLoadingIcon","NcModal","isMobile","a","b","davPermissions","subscribe","unsubscribe","isActive","oldFileInfo","restoreStartedEventState","emit","showSuccess","showError","oldLabel","index","versions","v","Vue","n","VTooltip","View","VersionTab","TabInstance","el","context"],"mappings":"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"}